<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
<id>vbgamer45:smfgallerypro</id>
<version>5.0</version>


<file name="$sourcedir/Subs-Graphics.php"  error="skip">

	<operation error="ignore">
		<search position="replace"><![CDATA[function resizeImageFile($source, $destination, $max_width, $max_height, $preferred_format = 0)
{
	global $sourcedir;]]></search>
	<add><![CDATA[function resizeImageFile($source, $destination, $max_width, $max_height, $preferred_format = 0)
{
	global $sourcedir;

	// SMF Gallery
	global $modSettings;
	$extension = strtolower(substr(strrchr($source, '.'), 1));
	if ($extension  == 'bmp')
	{
		$preferred_format = "6";
	}
	// End SMF Gallery

]]></add>
	</operation>



		<operation error="ignore">
		<search position="replace"><![CDATA[$mime_valid = check_mime_type($source, implode('|', array_map('image_type_to_mime_type', array_keys($default_formats))), true);
		if (empty($mime_valid))
			return false;]]></search>
	<add><![CDATA[$mime_valid = check_mime_type($source, implode('|', array_map('image_type_to_mime_type', array_keys($default_formats))), true);
		// SMF Gallery Change
		if (empty($mime_valid) && empty($modSettings['gallery_ovveride_mime']))
			return false;


]]></add>
	</operation>

		<operation error="ignore">
		<search position="replace"><![CDATA[elseif (function_exists('imagejpeg'))]]></search>
	<add><![CDATA[elseif (!empty($preferred_format) && ($preferred_format == 6) && function_exists('imagebmp'))
		{
			$success = imagebmp($dst_img, $destName);
		}
		elseif (function_exists('imagejpeg'))]]></add>
	</operation>


		<operation error="ignore">
		<search position="replace"><![CDATA[static $default_formats = array(
		'1' => 'gif',
		'2' => 'jpeg',
		'3' => 'png',
		'6' => 'bmp',
		'15' => 'wbmp'
	);

	// Get the image file, we have to work with something after all]]></search>
	<add><![CDATA[static $default_formats = array(
		'1' => 'gif',
		'2' => 'jpeg',
		'3' => 'png',
		'6' => 'bmp',
		'15' => 'wbmp',
		'18' => 'webp',
		'19' => 'avif',
	);

	// Get the image file, we have to work with something after all]]></add>
	</operation>

		<operation error="ignore">
		<search position="replace"><![CDATA[static $default_formats = array(
			'1' => 'gif',
			'2' => 'jpeg',
			'3' => 'png',
			'6' => 'bmp',
			'15' => 'wbmp'
		);
		$preferred_format = empty($preferred_format) || !isset($default_formats[$preferred_format]) ? 2 : $preferred_format;]]></search>
	<add><![CDATA[static $default_formats = array(
			'1' => 'gif',
			'2' => 'jpeg',
			'3' => 'png',
			'6' => 'bmp',
			'15' => 'wbmp',
			'18' => 'webp',
			'19' => 'avif',
		);
		$preferred_format = empty($preferred_format) || !isset($default_formats[$preferred_format]) ? 2 : $preferred_format;]]></add>
	</operation>

		<operation error="ignore">
		<search position="before"><![CDATA[elseif (!empty($preferred_format) && ($preferred_format == 1) && function_exists('imagegif'))
			$success = imagegif($dst_img, $destName);]]></search>
	<add><![CDATA[elseif (!empty($preferred_format) && ($preferred_format == 18) && function_exists('imagewebp'))
		$success = imagewebp($dst_img, $destName);
		elseif (!empty($preferred_format) && ($preferred_format == 19) && function_exists('imageavif'))
			$success = imageavif($dst_img, $destName);]]></add>
	</operation>
</file>
</modification>
