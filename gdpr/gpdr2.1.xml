<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
<id>vbgamer45:gpdrhelper</id>
<version>1.0</version>
<file name="$languagedir/Modifications.english.php">
	<operation>
		<search position="after"><![CDATA[
?>]]></search>
		<add><![CDATA[
// Begin GPDR Helper Text Strings
$txt['gpdr_title'] = 'GDPR Helper';

$txt['gpdr_privacypolicy'] = 'Privacy Policy';
$txt['gpdr_text_settings'] = 'Settings';
$txt['gpdr_txt_exportdata']  = 'Export Data';

$txt['gpdr_txt_privacy_header'] = 'Privacy Policy/Cookies';
$txt['gpdr_txt_privacy_desc'] = 'We collect personal information when you use our online services. We use cookies to identify you and to personalize your experience. For details, please see our <a href="' . $scripturl . '?action=gpdr;sa=privacypolicy" target="_blank">Privacy Policy</a>';
$txt['gpdr_txt_privacy_agree'] = 'I agree and consent to the Privacy Policy';
$txt['gpdr_txt_privacy_fail'] = 'We can not process your registration if do not agree to our Privacy Policy';



// END GPDR Helper Text Strings
]]></add>
	</operation>
</file>

<file name="$languagedir/Modifications.english-utf8.php" error="skip">
	<operation>
		<search position="after"><![CDATA[
?>]]></search>
		<add><![CDATA[
// Begin GPDR Helper Text Strings
$txt['gpdr_title'] = 'GDPR Helper';

$txt['gpdr_privacypolicy'] = 'Privacy Policy';
$txt['gpdr_text_settings'] = 'Settings';
$txt['gpdr_txt_exportdata']  = 'Export Data';

$txt['gpdr_txt_privacy_header'] = 'Privacy Policy/Cookies';
$txt['gpdr_txt_privacy_desc'] = 'We collect personal information when you use our online services. We use cookies to identify you and to personalize your experience. For details, please see our <a href="' . $scripturl . '?action=gpdr;sa=privacypolicy" target="_blank">Privacy Policy</a>';
$txt['gpdr_txt_privacy_agree'] = 'I agree and consent to the Privacy Policy';
$txt['gpdr_txt_privacy_fail'] = 'We can not process your registration if do not agree to our Privacy Policy';



// END GPDR Helper Text Strings
]]></add>
	</operation>
</file>


<file name="$sourcedir/Load.php">

	<operation>
		<search position="before"><![CDATA[// We are ready to go.
	$context['theme_loaded'] = true;]]></search>
		<add><![CDATA[
// Start GPDR Helper
if (!empty($modSettings['gpdr_force_privacy_agree']) && !empty($modSettings['gpdr_enable_privacy_policy']) && !$user_info['is_guest'])
{
	$t = time();
	if (empty($options['gpdr_policydate']) || $modSettings['gpdr_last_privacydate'] > $options['gpdr_policydate'])
	{
		if (isset($_REQUEST['action']) && ($_REQUEST['action'] == 'gpdr' || $_REQUEST['action'] == 'logout'))
		{

		}
		else
		{
			redirectexit('action=gpdr;sa=privacypolicy;reagree=1');
		}
	}
}

if (!empty($modSettings['gpdr_force_agreement_agree'])  && !$user_info['is_guest'])
{

		if (empty($options['gpdr_agreementdate']) || $modSettings['gpdr_last_agreementdate'] > $options['gpdr_agreementdate'])
		{

			if (isset($_REQUEST['action']) && ($_REQUEST['action'] == 'gpdr' || $_REQUEST['action'] == 'logout'))
			{

			}
			else
			{
				redirectexit('action=gpdr;sa=registeragreement;reagree=1');
			}

		}


}

// END GPDR Helper
]]></add>
	</operation>
</file>


<file name="$sourcedir/Subs-Members.php">

	<operation>
		<search position="replace"><![CDATA[// Make these peoples' posts guest posts.
	$smcFunc['db_query']('', '
		UPDATE {db_prefix}messages
		SET id_member = {int:guest_id}' . (!empty($modSettings['deleteMembersRemovesEmail']) ? ',
			poster_email = {string:blank_email}' : '') . '
		WHERE id_member IN ({array_int:users})',
		array(
			'guest_id' => 0,
			'blank_email' => '',
			'users' => $users,
		)
	);]]></search>
		<add><![CDATA[
// Start GPDR Helper
if (empty($modSettings['gpdr_clear_memberinfo']))
{
// Make these peoples' posts guest posts.
	$smcFunc['db_query']('', '
		UPDATE {db_prefix}messages
		SET id_member = {int:guest_id}' . (!empty($modSettings['deleteMembersRemovesEmail']) ? ',
			poster_email = {string:blank_email}' : '') . '
		WHERE id_member IN ({array_int:users})',
		array(
			'guest_id' => 0,
			'blank_email' => '',
			'users' => $users,
		)
	);
}
else
{
global $sourcedir;

require_once($sourcedir . '/gpdr2.php');
GPDR_CleanMemberInfo($users);
}

// END GPDR Helper
]]></add>
	</operation>
</file>

<file name="$sourcedir/Profile.php">

	<operation>
		<search position="before"><![CDATA['lists' => array(
					'label' => $txt['editBuddyIgnoreLists'],
					'file' => 'Profile-Modify.php',
					'function' => 'editBuddyIgnoreLists',
					'icon' => 'frenemy',
					'enabled' => !empty($modSettings['enable_buddylist']) && $context['user']['is_owner'],
					'sc' => 'post',
					'subsections' => array(
						'buddies' => array($txt['editBuddies']),
						'ignore' => array($txt['editIgnoreList']),
					),
					'permission' => array(
						'own' => array('profile_extra_any', 'profile_extra_own'),
						'any' => array(),
					),
				),]]></search>
		<add><![CDATA[
// Start GPDR Helper
				'exportdata' => array(
					'label' => $txt['gpdr_txt_exportdata'],
					'file' => 'Profile-gpdr2.php',
					'function' => 'GPDR_ExportProfile',
					'enabled' => !empty($modSettings['gpdr_allow_export_userdata']),
					'icon' => 'gdpr.png',
					'sc' => 'post',
					'permission' => array(
						'own' => array('profile_identity_any', 'profile_identity_own', 'manage_membergroups'),
						'any' => array('profile_identity_any', 'manage_membergroups'),
					),
				),
// END GPDR Helper
]]></add>
	</operation>
</file>

<file name="$sourcedir/QueryString.php">
		<operation>
			<search position="replace"><![CDATA[// If $scripturl is set to nothing, or the SID is not defined (SSI?) just quit.]]></search>
			<add><![CDATA[
// Start GPDR Helper

		if (!empty($modSettings['gpdr_enable_privacy_policy']))
		{
		global $txt;


		$buffer = preg_replace('~(class="new_win">Simple Machines</a>)~', 'class="new_win">Simple Machines</a><br /><a href="' . $scripturl . '?action=gpdr;sa=privacypolicy">' . $txt['gpdr_privacypolicy'] . '</a>', $buffer);
		$buffer = preg_replace('~(rel="noopener">Simple Machines</a>)~', 'class="new_win">Simple Machines</a><br /><a href="' . $scripturl . '?action=gpdr;sa=privacypolicy">' . $txt['gpdr_privacypolicy'] . '</a>', $buffer);



		}


// END GPDR Helper

	// If $scripturl is set to nothing, or the SID is not defined (SSI?) just quit.]]></add>
	</operation>

</file>


<file name="$sourcedir/Register.php">
		<operation>
			<search position="after"><![CDATA[// Lets check for other errors before trying to register the member.]]></search>
			<add><![CDATA[
// Start GPDR Helper
	if (!empty($modSettings['gpdr_enable_privacy_policy']))
	{
		if (!isset($_REQUEST['privacy_agree']))
			$reg_errors[] = $txt['gpdr_txt_privacy_fail'];
	}
// END GPDR Helper
]]></add>
	</operation>


		<operation>
			<search position="before"><![CDATA[// Do our spam protection now.
	spamProtection('register');]]></search>
			<add><![CDATA[
// Start GPDR Helper
if (!is_array($memberID))
{
	global $smcFunc, $settings;
        $t = time();
          $smcFunc['db_query']('', "
				REPLACE INTO {db_prefix}themes
					(ID_MEMBER, ID_THEME, variable, value)
				VALUES
                (" . $memberID . "," . $settings['theme_id']  . ",'gpdr_agreementdate','$t')
                ");


	if (!empty($modSettings['gpdr_enable_privacy_policy']))
	{
          $smcFunc['db_query']('', "
				REPLACE INTO {db_prefix}themes
					(ID_MEMBER, ID_THEME, variable, value)
				VALUES
                (" . $memberID . "," . $settings['theme_id']  . ",'gpdr_policydate','$t')
                ");
    }

        cache_put_data('theme_settings-' . $settings['theme_id'] . ':' . $memberID, null, 60);
}
// END GPDR Helper
]]></add>
	</operation>

</file>



<file name="$sourcedir/ManageRegistration.php">
		<operation>
			<search position="before"><![CDATA[updateSettings(array('requireAgreement' => !empty($_POST['requireAgreement'])));]]></search>
			<add><![CDATA[
// Start GPDR Helper

    	updateSettings(
	array(
    'gpdr_last_agreementdate' => time(),

	));


// END GPDR Helper
]]></add>
	</operation>

</file>

<file name="$themedir/Register.template.php">
		<operation>
			<search position="after"><![CDATA[echo '
			<div id="confirm_buttons" class="flow_auto">';]]></search>
			<add><![CDATA[
// Start GPDR Helper

if (!empty($modSettings['gpdr_enable_privacy_policy']))
{
		echo '
			<div class="title_bar">
				<h4 class="titlebg">', $txt['gpdr_txt_privacy_header'], '</h4>
			</div>
			<div class="windowbg2">
				<span class="topslice"><span></span></span>
				' . $txt['gpdr_txt_privacy_desc'] . '
				<br />
				<dl>
					<dt class="register_form"><strong><label for="privacy_agree">', $txt['gpdr_txt_privacy_agree'], ':</label></strong></dt>
						<dd>
							<input type="checkbox" name="privacy_agree" id="privacy_agree" tabindex="', $context['tabindex']++, '" class="input_check" />
						</dd>
					</dl>
				<span class="botslice"><span></span></span>
			</div>';

}

// END GPDR Helper
]]></add>
	</operation>

</file>

</modification>